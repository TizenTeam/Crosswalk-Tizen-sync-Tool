#!/bin/bash
#
# Copyright 2013, Intel Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Library General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
# native
#
#Created on  06 fevr. 2014
#
#@author: ronan.lemartret@open.eurogiciel.org
#

#This should fetch Crosswalk into src/xwalk and generate a
#   .gclient-xwalk with the other dependencies.



UPSTREAM_SRC=${PWD}
TIZEN_DST=${PWD}/pre-deliver
ROOTDIR=${PWD}

mkdir -p ${UPSTREAM_SRC}
mkdir -p ${TIZEN_DST}

# Catch GClient
[ -d depot_tools ] || git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
cd depot_tools
git pull
cd ..

PATH=$PWD/depot_tools:$PATH

# Catch Crosswalk upstream project
cd ${UPSTREAM_SRC}

gclient sync

#This will fetch all the other source files but not run any hooks.
gclient sync --gclientfile=.gclient-xwalk --nohooks

#Generate the LASTCHANGE files.
source_root=$(pwd)
python $source_root/src/build/util/lastchange.py \
       -o $source_root/src/build/util/LASTCHANGE \
       -s $source_root/src

python $source_root/src/build/util/lastchange.py \
       -o $source_root/src/build/util/LASTCHANGE.blink \
       -s $source_root/src/third_party/WebKit

ln -s src/xwalk/packaging .

# gbs build --include-all -A x86_64 -P generic-x86_64 --define 'BUILDDIR_NAME /var/tmp/xwalk-build' -C
cd $ROOTDIR

exit 0

#Import the sources
mkdir -p ${TIZEN_DST}/src
rm -fr ${TIZEN_DST}/src/*

cp -ra ${UPSTREAM_SRC}/src/* ${TIZEN_DST}/src/
#Clean git project
find ${TIZEN_DST}/src -type d -name '.git' -exec rm -fr {} \;
find ${TIZEN_DST}/src -type d -name '.gitignore' -exec rm -f {} \;
#Clean SVN project
find ${TIZEN_DST}/src -type d -name '.svn' -exec rm -fr {} \;


#Import packging (gbs do not allow link.)
mkdir -p ${TIZEN_DST}/packaging
rm ${TIZEN_DST}/packaging/*
cp ${UPSTREAM_SRC}/src/xwalk/packaging/* ${TIZEN_DST}/packaging/
rm -f ${TIZEN_DST}/packaging/gbp*
